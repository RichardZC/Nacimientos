@model IEnumerable<BE.caja>
<div class="row">
    <div class="col s12 m12 l12">
        <div class="card-panel">
            <div class="row">
                <form class="col s12">
                    <h4 class="header2">Gestión de Caja</h4>
                    <table class="striped">
                        <thead>
                            <tr>
                                <th>Caja</th>
                                <th>Estado</th>
                                <th>Cajero</th>
                                <th>Fecha Inicio</th>
                                <th>Saldo Inicio</th>
                                <th>Entradas</th>
                                <th>Salidas</th>
                                <th>Saldo Fin</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model)
                            {
                                <tr>
                                    <td>@item.Denominacion</td>
                                    <td id="estado_@item.CajaId">
                                        @(item.IndAbierto ? "Abierto" : "Cerrado")                                       
                                    </td>
                                    <td id="persona_@item.CajaId">
                                        @if (item.IndAbierto)
                                        {
                                            @item.cajadiario.First().persona.NombreCompleto
                                        }
                                        else
                                        {
                                            <button onclick="Mostrar(@item.CajaId,'@item.Denominacion');return false;" class="btn waves-effect waves-light ">
                                                Asignar
                                                <i class="mdi-content-send right"></i>
                                            </button>
                                        }
                                    </td>
                                    <td id="fechaInicio_@item.CajaId">
                                        @if (item.IndAbierto)
                                        {
                                            @item.cajadiario.First().FechaInicio
                                        }
                                    </td>
                                    <td id="saldoInicial_@item.CajaId">
                                        @if (item.IndAbierto)
                                        {
                                            @item.cajadiario.First().SaldoInicial
                                        }
                                    </td>
                                    <td id="entradas_@item.CajaId">
                                        @if (item.IndAbierto)
                                        {
                                            @item.cajadiario.First().Entradas   
                                        }
                                    </td>
                                    <td id="salidas_@item.CajaId">
                                        @if (item.IndAbierto)
                                        {
                                            @item.cajadiario.First().Salidas
                                        }
                                    </td>
                                    <td id="saldoFinal_@item.CajaId">
                                        @if (item.IndAbierto)
                                        {
                                            @item.cajadiario.First().SaldoFinal
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                    <button onclick="nuevaCaja(); " type="button" class="btn cyan waves-effect waves-light right">
                        Nueva Caja
                        <i class="mdi-content-add-circle-outline right"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<div id="modal1" class="modal" aria-hidden=true>
    <form id="formValidate" action='@Url.Action("Guardar","Cajadiario")' method="post">
        <input id="CajaId" name="pCajaId" type="hidden" value="0" />
        <div class="modal-content" style="padding:0">
            <nav class="red">
                <div class="nav-wrapper">
                    <div class="left col s12 m5 l5">
                        <ul>
                            <li>
                                <a href="#!" class="email-menu"><i class="modal-action modal-close  mdi-navigation-close"></i></a>
                            </li>
                            <li><span id="tituloCaja"></span></li>
                        </ul>
                    </div>
                    <div class="col s12 m7 l7">
                        <ul class="right">
                            <li>
                                <button type="submit" data-ajax="true" class="btn btn-large btn-flat red white-text " style="vertical-align:baseline;height:auto;"><i class="modal-action mdi-content-save"></i></button>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>
        </div>
        <div class="model-email-content">
            <div class="row">
                <div class="col s12 m8 l12">
                    <div class="input-field col s12">
                        <select name="pPersonaId" id="drpUsuario"></select>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="input-field col s12 m8 l6">
                    <p><label><span id="mensajeBoveda"></span></label></p>
                </div>
                <div id="mostrarSaldo" class="input-field col s12 m8 l6">
                    <i class="mdi-editor-attach-money prefix"></i>
                    <label for="txtSaldoInicial" class="" data-error="Ingrese monto correcto">Monto Inicial</label>

                    <input id="txtSaldoInicial" name="SaldoInicial" type="number" data-error=".errorTxt1" class="required number">
                    <div class="errorTxt1"></div>
                </div>
            </div>
        </div>
    </form>
</div>


@section scripts{
    <script>
        $(function () {
            $('.modal-add').leanModal({
                ready: function () {
                    $("#txtSaldoInicial").focus();
                }
            });
        });

        $("#formValidate").validate({
            errorElement: 'div',
            errorPlacement: function (error, element) {
                var placement = $(element).data('error');
                if (placement) {
                    $(placement).append(error)
                } else {
                    error.insertAfter(element);
                }
            }
        });

        function Mostrar(cajaId, CajaName) {
            $.get('@Url.Action("ContarUsuariosCajaAsignar", "Cajadiario")', function (r) {
                if (r > 0) {
                    $.get('@Url.Action("ObtenerSaldoBoveda", "Cajadiario")', function (d) {
                        $("#mensajeBoveda").text('En la bóveda hay un saldo de S/. ' + d);
                        $("#txtSaldoInicial").prop('max', d);
                    });
                    fn.CargarCombo("@Url.Action("ComboUsuariosCajaAsignar", "CajaDiario")", "drpUsuario");

                    $('#modal1').openModal();
                    $("#CajaId").val(cajaId);
                    $("#tituloCaja").text(CajaName);
                    $('#txtSaldoInicial').empty();
                }
                else {
                    fn.mensaje("NO EXISTE USUARIO DISPONIBLE PARA ASIGNAR");
                }
            });
        }

        function RefreshRowOf(id, persona, fechaInicio, saldoInicial,entradas,salidas, saldoFinal) {
            $("#estado_" + id).text('Abierto');
            $("#persona_" + id).text(persona);
            $("#fechaInicio_" + id).text(fechaInicio);
            $("#saldoInicial_" + id).text(saldoInicial.toFixed(2));
            $("#entradas_" + id).text(entradas.toFixed(2));
            $("#salidas_" + id).text(salidas.toFixed(2));
            $("#saldoFinal_" + id).text(saldoFinal.toFixed(2));
            $('#modal1').closeModal();
        }

        function nuevaCaja() {
            fn.prompt("Nueva Caja", "", function (valor) {
                $.post('@Url.Action("GuardarCaja", "Cajadiario")', { cajaId: 0, nombre: valor }, function (d) {
                    window.location.reload(true);
                });
            });

        }
    </script>
}      